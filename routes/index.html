<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Bootstrap, from Twitter</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="">

		<!-- Le styles -->
		<link href="../css/bootstrap.css" rel="stylesheet">
		<style>
			body {
				padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
			}
		</style>
		<link href="../css/bootstrap-responsive.css" rel="stylesheet">

		<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="../js/html5shiv.js"></script>
		<![endif]-->

		<!-- Fav and touch icons -->
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="../ico/apple-touch-icon-57-precomposed.png">
		<link rel="shortcut icon" href="../ico/favicon.png">
		<script src="/js/jquery.js"></script>
		<script src="/socket.io/socket.io.js"></script>
<script>
//(function() {
$.fn.serializeObject = function(){
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
};

var collabio = {
	socket: io.connect('http://'+document.domain),
	PeerConnection: window.PeerConnection || window.webkitPeerConnection00 || window.webkitRTCPeerConnection,
	roomID: function(){
		var url = document.URL.split('/');
		if( url[4] ) 
			return url[4];
		else
			return false;
	},
	initialize: function (){
		console.log("Initiliazing Room...");
		if(this.PeerConnection){
			console.log("WEBRTC available!");
		//	rtc.createStream({
		//		"video": true,
		//		"audio": true
		//	}, function(stream) {
		//		document.getElementById('you').src = URL.createObjectURL(stream);
		//		videos.push(document.getElementById('you'));
		//		//rtc.attachStream(stream, 'you');
		//		subdivideVideos();
		//	});
		}else{
			alert('Your browser is not supported or you have to turn on flags. In chrome you go to chrome://flags and turn on Enable PeerConnection remember to restart chrome');
		}
	}
}
$(document).ready(function(){
	//Inquire Room
	//If Room, Join
	if( collabio.roomID() ){
		$('h3.lead').html("Join the Room");
		$('.getRoom form button').html("Join!");
	}

	//Show Modal
	$('div.modal.getRoom').on('shown', function () {
		$("input.name").focus();
	}).modal({
		show: true,
		keyboard: false
	});

	//Sign In
	$(".getRoom form").submit(function(e){
		e.preventDefault();

		if( collabio.roomID() )
			collabio.socket.emit('joinRoom', $(this).serializeObject());
		else
			collabio.socket.emit('createRoom', $(this).serializeObject());
	});

	//Get Room if Avaialable
	collabio.socket.on('roomAvailable', function(data){
		history.pushState(null, "", "/r/"+data);
		$('div.modal.getRoom').modal('hide');
	});

	//Send Chat Message
	$("div.chat form").submit(function(e){
		e.preventDefault();
		collabio.socket.emit('sendChat', $(this).serializeObject());
	});

	//Receive Chat Messages
	collabio.socket.on('receiveChat', function(data){
		$("ul.conversation").html('');
		data.forEach(function(e){
			var time = new Date(e.time),
				html = '<li title="' + time.getHours() + ':' + time.getMinutes() + ':' + time.getSeconds() + '"><span class="userName">' + e.userName + '</span> ' + e.text + '</li>';
			console.log(e);
			$("ul.conversation").append(html);
		});
		$("ul.conversation").scrollTop($("ul.conversation").height());
	});
});

//})();
</script>
<style>
html, body, .container-fluid, .row-fluid{
	height:100%;
	padding: 0 !important;
}
form{
	margin: 0;
}
div.modal.getRoom{
	width: 360px;
	margin-left: -180px;
}
div.modal.getRoom.in{
	top: 20%;
}
div.modal.getRoom form input.name{
	font-size: 20px;
	padding: 3px 6px;
	width: 315px;
	height: auto;
	margin-bottom: 10px;
}
.column{
	padding-top: 41px;
	position: relative;
}
.column.left{
	height: 100%;
	border-right:1px solid #999;
}
.column.left canvas{
	width:100%;
	height: 60%;
	border-bottom: 1px solid #999;
}
.chat{
	height: 40%;
}
.chat ul.conversation{
	background-color: #ccc;
	overflow: scroll;
	height: 220px;
}
.chat ul.conversation span.userName{
	font-weight:bold;

}
</style>
	</head>

	<body>
		<div class="modal fade getRoom">
			<div class="modal-header">
				<h3 class="lead">Enter your name to create a room</h3>
			</div>
			<div class="modal-body">
				<form class="form-inline">
				<input type="text" class="name" name="name" placeholder="What's your name?">
				<button class="btn btn-primary pull-right">Create Room</button>
				</form>
			</div>
		</div>
		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="brand" href="#">Collab.io</a>
					<div class="nav-collapse collapse">
						<ul class="nav">
							<li class="active"><a href="#">Home</a></li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>

		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span8 column left">
					<canvas class="draw"></canvas>
					<div class="chat">
						<ul class="conversation">
						</ul>
						<div>
							<form>
								<input type="text" name="text">
							</form>
						</div>
					</div>
				</div>
				<div class="span4 column right">
					<div class="questions">
						questions
					</div>
					<video class="video"></video>
				</div>
			</div>
		</div>
		<script src="../js/bootstrap-modal.js"></script>

	</body>
</html>
