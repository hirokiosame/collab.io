<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Bootstrap, from Twitter</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="">

		<!-- Le styles -->
		<link href="../css/bootstrap.css" rel="stylesheet">
		<style>
			body {
				padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
			}
		</style>
		<link href="../css/bootstrap-responsive.css" rel="stylesheet">

		<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="../js/html5shiv.js"></script>
		<![endif]-->

		<!-- Fav and touch icons -->
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="../ico/apple-touch-icon-57-precomposed.png">
		<link rel="shortcut icon" href="../ico/favicon.png">
		<script src="/js/jquery.js"></script>
		<script src="/socket.io/socket.io.js"></script>
<script>
//(function() {
$.fn.serializeObject = function(){
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
};


//Draw
var Draw = {};
Draw.init = function() {
	Draw.canvas = document.createElement('canvas');
	Draw.canvas.height = 400;
	Draw.canvas.width = 800;
	document.getElementsByTagName('article')[0].appendChild(Draw.canvas);

	//Draw.canvas
	Draw.canvas.offset = $(Draw.canvas).offset();
	Draw.ctx = Draw.canvas.getContext("2d");
	Draw.ctx.rect(0, 0, Draw.canvas.width, Draw.canvas.height);
	Draw.ctx.fillStyle = "white";
	Draw.ctx.fill();
	Draw.ctx.strokeStyle = "#123";
	Draw.ctx.lineWidth = 2;
	Draw.ctx.lineCap = "round";
	Draw.socket = io.connect('http://localhost:4000');
	Draw.socket.on('draw', function(data) {
		console.log("history");
		console.log(data);
		for (var i = 0, limit = data.length; i < limit; i ++) {
			Draw.draw(data[i].x, data[i].y, data[i].type,data[i].color,data[i].stroke);
		}
		
	});

	Draw.draw = function(x, y, type,color,stroke) {
		Draw.ctx.strokeStyle = color;
		Draw.ctx.lineWidth = stroke;
		//console.log('x: '+x+" y: "+y+" color: "+Draw.ctx.strokeStyle+" stroke: "+stroke);
		if (type === "dragstart") {
			Draw.ctx.beginPath();
			return Draw.ctx.moveTo(x, y);
		} else if (type === "drag") {
			Draw.ctx.lineTo(x, y);
			return Draw.ctx.stroke();
		} else {
			return Draw.ctx.closePath();
		}
	};

	Draw.sendImage = function () {
		var img = Draw.canvas.toDataURL('image/jpeg');
		$.ajax({
			type: "POST",
			url: "/save.js",
			data: img,
			dataType: 'json',
			success: function(data) {
				console.log("png sent");
			},
			fail: function() {
				console.log("png failed");
			}
		});
	};


};








var collabio = {
	socket: io.connect('http://'+document.domain),
	PeerConnection: window.PeerConnection || window.webkitPeerConnection00 || window.webkitRTCPeerConnection,
	roomID: function(){
		var url = document.URL.split('/');
		if( url[4] ) 
			return url[4];
		else
			return false;
	},
	initialize: function (){
		console.log("Initiliazing Room...");
		if(this.PeerConnection){
			console.log("WEBRTC available!");
		//	rtc.createStream({
		//		"video": true,
		//		"audio": true
		//	}, function(stream) {
		//		document.getElementById('you').src = URL.createObjectURL(stream);
		//		videos.push(document.getElementById('you'));
		//		//rtc.attachStream(stream, 'you');
		//		subdivideVideos();
		//	});
		}else{
			alert('Your browser is not supported or you have to turn on flags. In chrome you go to chrome://flags and turn on Enable PeerConnection remember to restart chrome');
		}
	}
}
$(document).ready(function(){
	//Inquire Room
	//If Room, Join
	if( collabio.roomID() ){
		$('h3.lead').html("Join the Room");
		$('.getRoom form button').html("Join!");
	}

	//Show Modal
	$('div.modal.getRoom').on('shown', function () {
		$("input.name").focus();
	}).modal({
		show: true,
		keyboard: false
	});

	//Sign In
	$(".getRoom form").submit(function(e){
		e.preventDefault();

		if( collabio.roomID() )
			collabio.socket.emit('joinRoom', $(this).serializeObject());
		else
			collabio.socket.emit('createRoom', $(this).serializeObject());
	});

	//Get Room if Avaialable
	collabio.socket.on('roomAvailable', function(data){
		history.pushState(null, "", "/r/"+data);
		$('div.modal.getRoom').modal('hide');
	});


	/* Chat */
	//Send Chat Message
	$("div.chat form").submit(function(e){
		e.preventDefault();
		collabio.socket.emit('sendChat', $(this).serializeObject());
	});

	//Receive Chat Messages
	collabio.socket.on('receiveChat', function(data){
		$("ul.conversation").html('');
		data.forEach(function(e){
			var time = new Date(e.time),
				html = '<li title="' + time.getHours() + ':' + time.getMinutes() + ':' + time.getSeconds() + '"><span class="userName">' + e.userName + '</span> ' + e.text + '</li>';
			console.log(e);
			$("ul.conversation").append(html);
		});
		$("ul.conversation").scrollTop($("ul.conversation").height());
	});


	/* Questions */
	$(".questions form").submit(function(e){
		e.preventDefault();
		collabio.socket.emit('askQuestion', $(this).serializeObject());
	});


	$(document).on('click', '.upvotebutton', function(e) {
		upvote($(this).attr('qid'));
	});

	$(document).on('click', '.downvotebutton', function(e) {
		downvote($(this).attr('qid'));
	});

	$(document).on('click', '.removebutton', function(e) {
		requestRemove($(this).attr('qid'));
	});	


	// update page in response to data push from server
	collabio.socket.on('update', function(data){
		adminFlag = data.admin;
		console.log(data);
		cleanData = new Array();
		data.questions.forEach(function(elem) {
			if (elem !== undefined && elem !== null) cleanData.push(elem);
		});

		cleanData.sort(function(a, b) {
			var aID = a.votes;
			var bID = b.votes;
			return (aID == bID) ? 0 : (aID > bID) ? -1 : 1;
		});
		$('#questions').html('');
		var newHTML = '';
		$.each(cleanData, function(i, val) {
			newHTML += '<li class="question">'+ val.question +' ('+val.votes+' votes) <div class="buttons"> <a href="#" class="upvotebutton" qid="'+val.qid+'">&#9650;</a><a href="#" class="downvotebutton" qid="'+val.qid+'">&#9660;</a>';
			if (adminFlag === true) newHTML += '<a href="#" class="removebutton" qid="'+val.qid+'">&#x00d7;</a>';
			newHTML += '</div></li>';
		});

		$('#questions').html(newHTML);
	});



	// question UI handlers
	function requestRemove(qid) {
		if (confirm("Remove this question?"))
			collabio.socket.emit('remove', qid);
	}

	function upvote(qid) {
		collabio.socket.emit('upvote', qid);
	}

	function downvote(qid) {
		collabio.socket.emit('downvote', qid);
	}







});

//})();
</script>
<style>
html, body, .container-fluid, .row-fluid{
	height:100%;
	padding: 0 !important;
}
form{
	margin: 0;
}
div.modal.getRoom{
	width: 360px;
	margin-left: -180px;
}
div.modal.getRoom.in{
	top: 20%;
}
div.modal.getRoom form input.name{
	font-size: 20px;
	padding: 3px 6px;
	width: 315px;
	height: auto;
	margin-bottom: 10px;
}
.column{
	padding-top: 41px;
	position: relative;
}
.column.left{
	height: 100%;
	border-right:1px solid #999;
}
.column.left canvas{
	width:100%;
	height: 60%;
	border-bottom: 1px solid #999;
}
.chat{
	height: 40%;
}
.chat ul.conversation{
	background-color: #ccc;
	overflow: scroll;
	height: 220px;
}
.chat ul.conversation span.userName{
	font-weight:bold;

}
</style>
	</head>

	<body>
		<div class="modal fade getRoom">
			<div class="modal-header">
				<h3 class="lead">Enter your name to create a room</h3>
			</div>
			<div class="modal-body">
				<form class="form-inline">
				<input type="text" class="name" name="name" placeholder="What's your name?">
				<button class="btn btn-primary pull-right">Create Room</button>
				</form>
			</div>
		</div>
		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="brand" href="#">Collab.io</a>
					<div class="nav-collapse collapse">
						<ul class="nav">
							<li class="active"><a href="#">Home</a></li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>

		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span8 column left">
					<canvas class="draw"></canvas>
					<div class="chat">
						<ul class="conversation">
						</ul>
						<div>
							<form>
								<input type="text" name="text">
							</form>
						</div>
					</div>
				</div>
				<div class="span4 column right">
					<div class="questions">
						<form>
							<textarea id="question"></textarea>
							<input type="submit" class="btn btn-primary" value="Ask">
						</form>
						<ul class="questions"></ul>
					</div>
					<video class="video"></video>
				</div>
			</div>
		</div>
		<script src="../js/bootstrap-modal.js"></script>

	</body>
</html>
